---
name: 视觉验证流程
description: 渲染结果与 Office 原生效果的像素级对比验证流程和检查清单
trigger: context
---

# 视觉验证流程

## 🎯 目标

确保渲染结果与 Microsoft Office 原生显示保持**像素级一致**。

---

## 📋 验证前置条件

### 1. 构建检查

```bash
# 必须在验证前完成构建
pnpm run build

# 如果构建失败，必须先修复所有错误
# TypeScript 类型错误优先级最高
```

### 2. 启动开发服务器

```bash
# 启动 playground 开发服务器
pnpm run pg:dev

# 默认地址: http://localhost:5173/
```

### 3. 准备参考截图

- 使用 Office 软件打开同一文档
- 截取需要验证的区域
- 保持相同的缩放比例

---

## 🔍 验证检查清单

### 一、布局验证

#### 1. 页面尺寸
- [ ] 页面宽度与 Office 一致
- [ ] 页面高度与 Office 一致
- [ ] 纸张比例正确（A4/Letter 等）

#### 2. 页边距
- [ ] 上边距正确
- [ ] 下边距正确
- [ ] 左边距正确
- [ ] 右边距正确
- [ ] 页眉/页脚距离正确

#### 3. 分页
- [ ] 分页位置正确
- [ ] 强制分页符工作正常
- [ ] 分节符处理正确

### 二、文本样式验证

#### 1. 字体
- [ ] 字体系列正确（考虑 Web 字体映射）
- [ ] 字号正确
- [ ] 粗体/斜体正确
- [ ] 下划线类型和颜色正确
- [ ] 删除线正确

#### 2. 颜色
- [ ] 文字颜色正确
- [ ] 高亮颜色正确
- [ ] 主题颜色解析正确
- [ ] 色调调整（tint/shade）正确

#### 3. 段落
- [ ] 对齐方式正确（左/中/右/两端）
- [ ] 首行缩进正确
- [ ] 段前/段后间距正确
- [ ] 行距正确

### 三、表格验证

#### 1. 结构
- [ ] 列数正确
- [ ] 行数正确
- [ ] 单元格合并正确（水平/垂直）

#### 2. 尺寸
- [ ] 列宽正确
- [ ] 行高正确
- [ ] 单元格内边距正确

#### 3. 样式
- [ ] 边框样式正确（单线/双线/虚线等）
- [ ] 边框颜色正确
- [ ] 边框宽度正确
- [ ] 单元格背景色正确
- [ ] 阴影效果正确

### 四、绘图元素验证

#### 1. 图片
- [ ] 图片完整显示
- [ ] 图片尺寸正确
- [ ] 图片位置正确
- [ ] 图片裁剪正确
- [ ] 图片特效正确（阴影、边框等）

#### 2. 形状
- [ ] 形状类型正确
- [ ] 形状路径准确
- [ ] 填充颜色/渐变正确
- [ ] 边框样式正确
- [ ] 形状尺寸正确
- [ ] 形状位置正确
- [ ] 旋转角度正确
- [ ] 翻转（水平/垂直）正确

#### 3. 连接符
- [ ] 连接符类型正确（直线/折线/曲线）
- [ ] 起点位置正确
- [ ] 终点位置正确
- [ ] 箭头样式正确
- [ ] 线条样式正确

#### 4. 多边形/自定义路径
- [ ] 路径形状正确
- [ ] 顶点位置准确
- [ ] 曲线平滑度正确

### 五、图表验证

#### 1. 类型
- [ ] 图表类型正确（柱状/折线/饼图等）
- [ ] 混合图表各系列类型正确

#### 2. 数据
- [ ] 数据点数量正确
- [ ] 数据值显示正确
- [ ] 数据标签位置正确

#### 3. 样式
- [ ] 图例显示正确
- [ ] 坐标轴正确
- [ ] 网格线正确
- [ ] 系列颜色正确
- [ ] 标题文字正确

### 六、特殊元素验证

#### 1. 页眉页脚
- [ ] 页眉内容正确
- [ ] 页脚内容正确
- [ ] 页码显示正确
- [ ] 日期/时间正确

#### 2. 列表
- [ ] 项目符号类型正确
- [ ] 编号格式正确
- [ ] 缩进层级正确
- [ ] 续编正确

#### 3. 公式
- [ ] 公式结构正确
- [ ] 符号显示正确
- [ ] 分数/根号/上下标正确
- [ ] 矩阵对齐正确

#### 4. 水印/背景
- [ ] 水印文字正确
- [ ] 水印位置正确
- [ ] 水印透明度正确
- [ ] 背景色正确

---

## 🐛 常见问题排查

### 1. 元素位置偏移

**可能原因**：
- EMU 到像素转换错误
- 坐标系原点不一致
- 未考虑容器的 padding/margin

**排查步骤**：
1. 使用浏览器开发者工具检查元素位置
2. 对比 XML 中的原始值和渲染后的像素值
3. 检查 `UnitConverter.emuToPixels()` 的调用

### 2. 元素尺寸不正确

**可能原因**：
- 单位转换错误
- 未考虑边框宽度
- 缩放比例问题

**排查步骤**：
1. 检查 XML 中的 `cx`, `cy` 或 `w`, `h` 值
2. 验证转换后的像素值
3. 检查 CSS `box-sizing` 设置

### 3. 颜色不匹配

**可能原因**：
- 主题颜色未正确解析
- Tint/Shade 计算错误
- ARGB 格式处理错误

**排查步骤**：
1. 使用颜色提取工具对比实际颜色值
2. 检查 `ColorUtils.applyTint()` 的调用
3. 验证主题颜色映射表

### 4. 文字样式差异

**可能原因**：
- 字体映射不正确
- 半点到像素转换错误
- 行距计算错误

**排查步骤**：
1. 检查 `FontManager` 的字体映射
2. 验证字号转换（`halfPointsToPoints`）
3. 检查 `line-height` 计算

### 5. 形状路径不准确

**可能原因**：
- 预设几何图形参数错误
- 调整参数（adj）未正确应用
- 自定义路径解析错误

**排查步骤**：
1. 查看 `ShapeRegistry` 中的形状定义
2. 检查 `a:avLst` 中的调整参数
3. 使用 SVG 路径预览工具验证

---

## ✅ 验证完成标准

验证通过需满足以下条件：

1. **构建成功**：`pnpm run build` 无错误
2. **类型检查通过**：无 TypeScript 类型错误
3. **视觉一致**：与 Office 截图像素级对比无明显差异
4. **功能完整**：所有可见元素均正确渲染
5. **无回归**：未引入新的渲染问题

---

## 📝 验证报告模板

```markdown
## 验证报告

### 文档信息
- 文件名: xxx.docx / xxx.xlsx
- 验证日期: YYYY-MM-DD
- 验证人: xxx

### 验证结果

| 类别 | 状态 | 备注 |
|------|------|------|
| 布局 | ✅/⚠️/❌ | |
| 文本样式 | ✅/⚠️/❌ | |
| 表格 | ✅/⚠️/❌ | |
| 绘图元素 | ✅/⚠️/❌ | |
| 图表 | ✅/⚠️/❌ | |
| 特殊元素 | ✅/⚠️/❌ | |

### 发现的问题

1. [问题描述]
   - 预期效果: xxx
   - 实际效果: xxx
   - 影响范围: xxx

### 截图对比

[附上 Office 截图和渲染结果截图]
```
